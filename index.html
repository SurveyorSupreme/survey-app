<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Surveyor Level Book - Pro</title>
    <style>
        :root { --primary: #0056b3; --success: #28a745; --danger: #dc3545; --dark: #343a40; --warning: #ffc107; }
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 10px; background: #f4f7f6; color: #333; }
        .card { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 12px; }
        label { display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; color: #666; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 1.1rem; box-sizing: border-box; }
        #ih_display { text-align: center; padding: 15px; background: #e7f1ff; border: 2px dashed var(--primary); border-radius: 8px; color: var(--primary); font-size: 1.4rem; font-weight: bold; margin-bottom: 15px; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { width: 100%; padding: 16px; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; cursor: pointer; color: white; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        .bg-blue { background: var(--primary); }
        .bg-green { background: var(--success); }
        .bg-red { background: var(--danger); }
        .bg-dark { background: var(--dark); }
        .bg-orange { background: #fd7e14; }
        .table-container { overflow-x: auto; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 550px; }
        th, td { padding: 10px; border: 1px solid #eee; text-align: center; font-size: 0.85rem; }
        th { background: var(--dark); color: white; }
        .rise { color: var(--success); font-weight: bold; }
        .fall { color: var(--danger); font-weight: bold; }
        .rl-cell { font-weight: bold; background: #fffde7; }
        .action-bar { margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <label>Start RL (Benchmark)</label>
        <input type="number" id="start_rl" step="0.001" placeholder="e.g. 23.756" inputmode="decimal">
        <label>Backsight (BS)</label>
        <input type="number" id="bs_val" step="0.001" placeholder="e.g. 0.965" inputmode="decimal">
        <button class="bg-blue" id="setupBtn">SET IH / SETUP</button>
    </div>

    <div id="ih_display">IH: NOT SET</div>

    <div class="card">
        <label>Reading (IS or FS)</label>
        <input type="number" id="reading" step="0.001" placeholder="0.000" inputmode="decimal">
        <label>Description</label>
        <input type="text" id="desc" placeholder="e.g. MH1, Kerb">
        <div class="btn-group">
            <button class="bg-green" id="isBtn">ADD IS</button>
            <button class="bg-red" id="fsBtn">ADD FS (CP)</button>
        </div>
    </div>

    <div class="table-container">
        <table id="levelTable">
            <thead>
                <tr>
                    <th>BS</th>
                    <th>IS</th>
                    <th>FS</th>
                    <th>Diff (+/-)</th>
                    <th>RL</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="action-bar">
        <button id="csvBtn" class="bg-dark">DOWNLOAD CSV</button>
        <button id="clearBtn" class="bg-orange">CLEAR ALL</button>
    </div>

    <script>
        let setupBS = null;
        let setupIH = null;
        // Load existing data from LocalStorage
        let surveyData = JSON.parse(localStorage.getItem('surveyData')) || [];

        // Re-render table on load if data exists
        window.onload = function() {
            if (surveyData.length > 0) {
                renderTable();
                // Attempt to pre-fill Start RL from last known RL
                const lastEntry = surveyData[surveyData.length - 1];
                document.getElementById('start_rl').value = lastEntry.rl.toFixed(3);
            }
        };

        document.getElementById('setupBtn').addEventListener('click', function() {
            const rl = parseFloat(document.getElementById('start_rl').value);
            const bs = parseFloat(document.getElementById('bs_val').value);
            if (isNaN(rl) || isNaN(bs)) return alert("Enter RL and BS");

            setupBS = bs;
            setupIH = rl + bs;
            document.getElementById('ih_display').innerText = "IH: " + setupIH.toFixed(3);
            
            saveRow(bs, null, null, 0, rl, "Start/BS Setup");
            document.getElementById('bs_val').value = "";
        });

        document.getElementById('isBtn').addEventListener('click', function() { addShot('IS'); });
        document.getElementById('fsBtn').addEventListener('click', function() { addShot('FS'); });

        function addShot(type) {
            if (setupIH === null) return alert("Set Setup/BS first!");
            const currentReading = parseFloat(document.getElementById('reading').value);
            const description = document.getElementById('desc').value || "-";
            if (isNaN(currentReading)) return alert("Enter reading");

            // Logic: BS - Current Reading = Diff relative to setup
            const diff = setupBS - currentReading;
            const rl = setupIH - currentReading;

            if (type === 'IS') {
                saveRow(null, currentReading, null, diff, rl, description);
            } else {
                saveRow(null, null, currentReading, diff, rl, description + " (CP)");
                document.getElementById('start_rl').value = rl.toFixed(3);
                setupIH = null;
                setupBS = null;
                document.getElementById('ih_display').innerText = "IH: SET NEW BS";
            }

            document.getElementById('reading').value = "";
            document.getElementById('desc').value = "";
        }

        function saveRow(bs, is, fs, diff, rl, desc) {
            surveyData.push({bs, is, fs, diff, rl, desc});
            // Auto-save to LocalStorage
            localStorage.setItem('surveyData', JSON.stringify(surveyData));
            renderTable();
        }

        function renderTable() {
            const tableBody = document.querySelector('#levelTable tbody');
            tableBody.innerHTML = "";
            surveyData.forEach((r, index) => {
                const row = tableBody.insertRow(-1);
                let diffClass = r.diff > 0 ? "rise" : (r.diff < 0 ? "fall" : "");
                let diffText = r.diff > 0 ? "+" + r.diff.toFixed(3) : (r.diff < 0 ? r.diff.toFixed(3) : "0.000");
                if (r.bs && !r.is && !r.fs) diffText = "---";

                row.innerHTML = `
                    <td>${r.bs ? r.bs.toFixed(3) : ''}</td>
                    <td>${r.is ? r.is.toFixed(3) : ''}</td>
                    <td>${r.fs ? r.fs.toFixed(3) : ''}</td>
                    <td class="${diffClass}">${diffText}</td>
                    <td class="rl-cell">${r.rl.toFixed(3)}</td>
                    <td>${r.desc}</td>
                `;
            });
        }

        document.getElementById('csvBtn').addEventListener('click', function() {
            if (surveyData.length === 0) return alert("No data to download!");

            const defaultName = "LevelRun_" + new Date().toISOString().slice(0,10);
            let fileName = prompt("Enter file name:", defaultName);
            
            if (fileName === null) return;
            if (fileName === "") fileName = defaultName;

            let csv = "BS,IS,FS,Diff,RL,Description\n";
            surveyData.forEach(r => {
                csv += `${r.bs||''},${r.is||''},${r.fs||''},${r.diff||''},${r.rl.toFixed(3)},${r.desc}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName + ".csv";
            a.click();
        });

        document.getElementById('clearBtn').addEventListener('click', function() {
            if (confirm("Are you sure? This will wipe all saved data from this device.")) {
                surveyData = [];
                localStorage.removeItem('surveyData');
                location.reload();
            }
        });
    </script>
</body>
</html>
